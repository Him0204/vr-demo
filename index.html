<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

    <style>
      #toneSelector {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 9999;
        background: rgba(0,0,0,0.7);
        padding: 8px 12px;
        border-radius: 6px;
        color: white;
        font-family: sans-serif;
      }

      #commentaryControls {
        position: absolute;
        top: 70px;
        left: 20px;
        z-index: 9999;
        background: rgba(0,0,0,0.7);
        padding: 8px 12px;
        border-radius: 6px;
        color: white;
        font-family: sans-serif;
        display: flex;
        gap: 8px;
        align-items: center;
      }

      #commentaryControls label {
        font-size: 12px;
        opacity: 0.8;
      }
    </style>
  </head>

  <body>
    <!-- Tone Switch UI -->
    <select id="toneSelector">
      <option value="hype">ðŸ”¥ Hype</option>
      <option value="calm">ðŸŒ™ Calm</option>
      <option value="analyst">ðŸ“Š Analyst</option>
    </select>

    <!-- Commentator voice controls -->
    <div id="commentaryControls">
      <label for="voiceSelector">Voice</label>
      <select id="voiceSelector">
        <option value="female">Woman</option>
        <option value="male">Man</option>
      </select>
      <button id="commentaryToggle">Play Commentary</button>
    </div>

    <!-- A-Frame VR Scene -->
    <a-scene>
      <!-- 360 video source (outside scene for better control) -->
      <a-assets>
        <video id="v360" src="video360v2.mp4" autoplay loop crossorigin="anonymous" playsinline muted></video>
      </a-assets>

      <!-- 360 video sphere -->
      <a-videosphere src="#v360"></a-videosphere>

      <!-- Camera with device orientation controls -->
      <a-entity camera look-controls="magicWindowTrackingEnabled: true; touchEnabled: true; mouseEnabled: true"></a-entity>

    </a-scene>

    <script>
      // Tone selector UI is kept for future soundtrack integration
      document.getElementById('toneSelector').addEventListener('change', (e) => {
        console.log('Selected tone:', e.target.value);
        // Audio playback will be implemented when soundtracks are available
      });

      // Ensure video plays
      const video = document.getElementById('v360');
      // Force normal playback speed in case the browser throttles or speeds it up
      video.playbackRate = 1;
      video.addEventListener('ratechange', () => {
        if (video.playbackRate !== 1) {
          video.playbackRate = 1;
        }
      });
      
      // Try to play video when scene is loaded
      document.querySelector('a-scene').addEventListener('loaded', () => {
        video.play().catch(e => {
          console.log('Autoplay prevented, click to start video');
        });
      });

      // Click anywhere to start video if autoplay fails
      document.body.addEventListener('click', () => {
        if (video.paused) {
          video.play();
        }
      }, { once: true });

      // Debug: check if video is loading
      video.addEventListener('loadeddata', () => {
        console.log('Video loaded successfully');
      });
      
      video.addEventListener('error', (e) => {
        console.error('Video error:', e);
      });

      // Commentator voice (man / woman) via Web Speech API
      const voiceSelector = document.getElementById('voiceSelector');
      const commentaryToggle = document.getElementById('commentaryToggle');
      let availableVoices = [];
      let commentaryOn = false;
      let speakingUtterance = null;

      const refreshVoices = () => {
        availableVoices = window.speechSynthesis.getVoices();
      };

      refreshVoices();
      window.speechSynthesis.onvoiceschanged = refreshVoices;

      const pickVoice = (gender) => {
        // Heuristic: prefer voice names that hint at gender, else fallback to first
        const lower = gender.toLowerCase();
        const prioritized = availableVoices.find(v => v.name.toLowerCase().includes(lower))
          || availableVoices.find(v => v.name.toLowerCase().includes('female') && gender === 'female')
          || availableVoices.find(v => v.name.toLowerCase().includes('male') && gender === 'male')
          || availableVoices[0];
        return prioritized || null;
      };

      const toneLines = {
        hype: 'What a moment! The crowd is electric as the play unfolds!',
        calm: 'Smooth and steady pace, every move measured and in control.',
        analyst: 'Notice the positioning here: spacing is tight, timing is perfect.',
      };

      const speakCommentary = () => {
        window.speechSynthesis.cancel();
        speakingUtterance = new SpeechSynthesisUtterance();
        const tone = document.getElementById('toneSelector').value;
        speakingUtterance.text = toneLines[tone] || toneLines.hype;
        speakingUtterance.rate = 1;
        speakingUtterance.pitch = 1;
        speakingUtterance.volume = 1;
        const chosenVoice = pickVoice(voiceSelector.value);
        if (chosenVoice) {
          speakingUtterance.voice = chosenVoice;
        }
        window.speechSynthesis.speak(speakingUtterance);
      };

      commentaryToggle.addEventListener('click', () => {
        commentaryOn = !commentaryOn;
        if (commentaryOn) {
          commentaryToggle.textContent = 'Stop Commentary';
          speakCommentary();
        } else {
          commentaryToggle.textContent = 'Play Commentary';
          window.speechSynthesis.cancel();
        }
      });

      // Re-speak when a speech event ends while still toggled on
      window.speechSynthesis.addEventListener('end', () => {
        if (commentaryOn) {
          speakCommentary();
        }
      });
    </script>

  </body>
</html>
