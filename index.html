<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

    <style>
      #toneSelector {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 9999;
        background: rgba(0,0,0,0.7);
        padding: 8px 12px;
        border-radius: 6px;
        color: white;
        font-family: sans-serif;
      }

      #videoSelector {
        position: absolute;
        top: 120px;
        left: 20px;
        z-index: 9999;
        background: rgba(0,0,0,0.7);
        padding: 8px 12px;
        border-radius: 6px;
        color: white;
        font-family: sans-serif;
      }

      #commentaryControls {
        position: absolute;
        top: 70px;
        left: 20px;
        z-index: 9999;
        background: rgba(0,0,0,0.7);
        padding: 8px 12px;
        border-radius: 6px;
        color: white;
        font-family: sans-serif;
        display: flex;
        gap: 8px;
        align-items: center;
      }

      #audioPrompt {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.85);
        z-index: 99999;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: white;
        font-family: sans-serif;
        text-align: center;
        padding: 20px;
      }

      #audioPrompt button {
        margin-top: 20px;
        padding: 15px 30px;
        font-size: 18px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }

      #audioPrompt button:hover {
        background: #45a049;
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body>
    <!-- Tone Switch UI -->
    <select id="toneSelector">
      <option value="female">Woman</option>
      <option value="male">Man</option>
    </select>

    <!-- Video source selector -->
    <select id="videoSelector">
      <option value="video360.mp4">Video 360 v1</option>
      <option value="video360v2.mp4" selected>Video 360 v2</option>
    </select>

    <!-- Commentator voice controls -->
    <div id="commentaryControls">
      <button id="commentaryToggle">Play Commentary</button>
      <span style="font-size:12px; opacity:0.8;">Tone uses selected voice</span>
    </div>

    <!-- Audio unlock prompt -->
    <div id="audioPrompt">
      <h2>ðŸ”Š Enable Audio</h2>
      <p>Tap to unlock audio and start commentary</p>
      <button id="unlockButton">Enable Sound</button>
    </div>

    <!-- A-Frame VR Scene -->
    <a-scene>
      <!-- 360 video source (outside scene for better control) -->
      <a-assets>
        <video id="v360" src="video360v2.mp4" autoplay loop crossorigin="anonymous" playsinline muted></video>
        <audio id="commentaryMale" src="Man.mp3" preload="auto"></audio>
        <audio id="commentaryFemale" src="Woman.mp3" preload="auto"></audio>
      </a-assets>

      <!-- 360 video sphere -->
      <a-videosphere src="#v360"></a-videosphere>

      <!-- Camera with device orientation controls -->
      <a-entity camera look-controls="magicWindowTrackingEnabled: true; touchEnabled: true; mouseEnabled: true"></a-entity>

    </a-scene>

    <script>
      // Tone selector now chooses commentary track (man / woman)
      const toneSelector = document.getElementById('toneSelector');

      // Ensure video plays
      const video = document.getElementById('v360');
      // Reinforce inline playback across mobile browsers
      video.setAttribute('playsinline', 'true');
      video.setAttribute('webkit-playsinline', 'true');
      video.muted = true; // keep muted for autoplay policy
      // Force normal playback speed in case the browser throttles or speeds it up
      video.playbackRate = 1;
      video.addEventListener('ratechange', () => {
        if (video.playbackRate !== 1) {
          video.playbackRate = 1;
        }
      });
      
      // Try to play video when scene is loaded
      document.querySelector('a-scene').addEventListener('loaded', () => {
        video.play().catch(e => {
          console.log('Autoplay prevented, click to start video');
        });
      });

      // Click anywhere to start video if autoplay fails
      document.body.addEventListener('click', () => {
        if (video.paused) {
          video.play();
        }
      }, { once: true });

      // Debug: check if video is loading
      video.addEventListener('loadeddata', () => {
        console.log('Video loaded successfully');
      });
      
      video.addEventListener('error', (e) => {
        console.error('Video error:', e);
      });

      // Commentator audio (man / woman) via MP3 tracks
      const commentaryToggle = document.getElementById('commentaryToggle');
      const maleAudio = document.getElementById('commentaryMale');
      const femaleAudio = document.getElementById('commentaryFemale');
      const commentaryTracks = {
        male: maleAudio,
        female: femaleAudio,
      };

      // Audio unlock handling for mobile (iOS/Android)
      let audioUnlocked = false;
      let pendingAutoCommentary = false;
      const audioPrompt = document.getElementById('audioPrompt');
      const unlockButton = document.getElementById('unlockButton');

      const unlockAudio = () => {
        console.log('Attempting to unlock audio...');
        console.log('Available tracks:', Object.keys(commentaryTracks));
        
        const promises = Object.values(commentaryTracks).map(track => {
          console.log('Track ready state:', track.readyState, 'src:', track.src);
          return track.play().then(() => {
            console.log('Track played successfully:', track.src);
            track.pause();
            track.currentTime = 0;
            return true;
          }).catch(err => {
            console.error('Audio unlock failed for', track.src, ':', err);
            return false;
          });
        });
        
        Promise.all(promises).then((results) => {
          audioUnlocked = results.some(r => r === true);
          console.log('Audio unlock results:', results, 'audioUnlocked:', audioUnlocked);
          audioPrompt.classList.add('hidden');
          
          if (audioUnlocked) {
            console.log('Audio unlocked successfully');
            if (pendingAutoCommentary) {
              pendingAutoCommentary = false;
              console.log('Starting pending commentary...');
              startCommentary();
            }
          } else {
            console.error('All audio tracks failed to unlock. Check file paths and browser console.');
            alert('Audio files not found. Ensure man.mp3 and woman.mp3 are in the same directory as index.html');
          }
        });
      };

      unlockButton.addEventListener('click', unlockAudio);
      
      // Debug: Check if audio files are loading
      Object.entries(commentaryTracks).forEach(([name, track]) => {
        track.addEventListener('loadeddata', () => {
          console.log(`${name} audio loaded successfully`);
        });
        track.addEventListener('error', (e) => {
          console.error(`${name} audio error:`, e, 'src:', track.src);
        });
      });

      // Video source switching
      const videoSelector = document.getElementById('videoSelector');
      const switchVideo = (src) => {
        video.pause();
        video.currentTime = 0;
        video.src = src;
        video.load();
        // Keep enforced settings
        video.playbackRate = 1;
        video.play().catch(err => console.warn('Video play blocked:', err));
      };

      videoSelector.addEventListener('change', (e) => {
        switchVideo(e.target.value);
      });

      Object.values(commentaryTracks).forEach(track => {
        track.loop = true;
        track.playbackRate = 1;
        track.volume = 1.0;
        track.muted = false;
        track.addEventListener('ratechange', () => {
          if (track.playbackRate !== 1) track.playbackRate = 1;
        });
      });

      let commentaryOn = false;

      const stopAllCommentary = () => {
        Object.values(commentaryTracks).forEach(track => {
          track.pause();
          track.currentTime = 0;
        });
      };

      const playSelectedCommentary = () => {
        stopAllCommentary();
        const selected = toneSelector.value;
        const track = commentaryTracks[selected];
        if (track) {
          track.play().catch(err => console.warn('Commentary play blocked:', err));
        }
      };

      const startCommentary = () => {
        commentaryOn = true;
        commentaryToggle.textContent = 'Stop Commentary';
        if (audioUnlocked) {
          playSelectedCommentary();
        } else {
          pendingAutoCommentary = true;
        }
      };

      commentaryToggle.addEventListener('click', () => {
        commentaryOn = !commentaryOn;
        if (commentaryOn) {
          commentaryToggle.textContent = 'Stop Commentary';
          playSelectedCommentary();
        } else {
          commentaryToggle.textContent = 'Play Commentary';
          stopAllCommentary();
        }
      });

      toneSelector.addEventListener('change', () => {
        if (commentaryOn) {
          playSelectedCommentary();
        }
      });

      // Auto-start commentary (default woman) once video begins playing
      video.addEventListener('playing', () => {
        if (!commentaryOn) {
          // Default tone is woman; will switch to man if selector is changed
          startCommentary();
        }
      });

      // If user taps after video already playing, ensure commentary starts once unlocked
      document.body.addEventListener('pointerdown', () => {
        if (pendingAutoCommentary && audioUnlocked) {
          pendingAutoCommentary = false;
          startCommentary();
        }
      });
    </script>

  </body>
</html>
