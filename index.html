<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

    <style>
      #toneSelector {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 9999;
        background: rgba(0,0,0,0.7);
        padding: 8px 12px;
        border-radius: 6px;
        color: white;
        font-family: sans-serif;
      }

      #commentaryControls {
        position: absolute;
        top: 70px;
        left: 20px;
        z-index: 9999;
        background: rgba(0,0,0,0.7);
        padding: 8px 12px;
        border-radius: 6px;
        color: white;
        font-family: sans-serif;
        display: flex;
        gap: 8px;
        align-items: center;
      }
    </style>
  </head>

  <body>
    <!-- Tone Switch UI -->
    <select id="toneSelector">
      <option value="female">Woman</option>
      <option value="male">Man</option>
    </select>

    <!-- Commentator voice controls -->
    <div id="commentaryControls">
      <button id="commentaryToggle">Play Commentary</button>
      <span style="font-size:12px; opacity:0.8;">Tone uses selected voice</span>
    </div>

    <!-- A-Frame VR Scene -->
    <a-scene>
      <!-- 360 video source (outside scene for better control) -->
      <a-assets>
        <video id="v360" src="video360v2.mp4" autoplay loop crossorigin="anonymous" playsinline muted></video>
        <audio id="commentaryMale" src="man.mp3" preload="auto"></audio>
        <audio id="commentaryFemale" src="woman.mp3" preload="auto"></audio>
      </a-assets>

      <!-- 360 video sphere -->
      <a-videosphere src="#v360"></a-videosphere>

      <!-- Camera with device orientation controls -->
      <a-entity camera look-controls="magicWindowTrackingEnabled: true; touchEnabled: true; mouseEnabled: true"></a-entity>

    </a-scene>

    <script>
      // Tone selector now chooses commentary track (man / woman)
      const toneSelector = document.getElementById('toneSelector');

      // Ensure video plays
      const video = document.getElementById('v360');
      // Force normal playback speed in case the browser throttles or speeds it up
      video.playbackRate = 1;
      video.addEventListener('ratechange', () => {
        if (video.playbackRate !== 1) {
          video.playbackRate = 1;
        }
      });
      
      // Try to play video when scene is loaded
      document.querySelector('a-scene').addEventListener('loaded', () => {
        video.play().catch(e => {
          console.log('Autoplay prevented, click to start video');
        });
      });

      // Click anywhere to start video if autoplay fails
      document.body.addEventListener('click', () => {
        if (video.paused) {
          video.play();
        }
      }, { once: true });

      // Debug: check if video is loading
      video.addEventListener('loadeddata', () => {
        console.log('Video loaded successfully');
      });
      
      video.addEventListener('error', (e) => {
        console.error('Video error:', e);
      });

      // Commentator audio (man / woman) via MP3 tracks
      const commentaryToggle = document.getElementById('commentaryToggle');
      const maleAudio = document.getElementById('commentaryMale');
      const femaleAudio = document.getElementById('commentaryFemale');
      const commentaryTracks = {
        male: maleAudio,
        female: femaleAudio,
      };

      Object.values(commentaryTracks).forEach(track => {
        track.loop = true;
        track.playbackRate = 1;
        track.addEventListener('ratechange', () => {
          if (track.playbackRate !== 1) track.playbackRate = 1;
        });
      });

      let commentaryOn = false;

      const stopAllCommentary = () => {
        Object.values(commentaryTracks).forEach(track => {
          track.pause();
          track.currentTime = 0;
        });
      };

      const playSelectedCommentary = () => {
        stopAllCommentary();
        const selected = toneSelector.value;
        const track = commentaryTracks[selected];
        if (track) {
          track.play().catch(err => console.warn('Commentary play blocked:', err));
        }
      };

      commentaryToggle.addEventListener('click', () => {
        commentaryOn = !commentaryOn;
        if (commentaryOn) {
          commentaryToggle.textContent = 'Stop Commentary';
          playSelectedCommentary();
        } else {
          commentaryToggle.textContent = 'Play Commentary';
          stopAllCommentary();
        }
      });

      toneSelector.addEventListener('change', () => {
        if (commentaryOn) {
          playSelectedCommentary();
        }
      });
    </script>

  </body>
</html>
