<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }

      #controlPanel {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.85);
        padding: 20px;
        border-radius: 12px;
        color: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        min-width: 260px;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }

      #controlPanel.minimized {
        min-width: auto;
        padding: 12px;
      }

      #controlPanel.minimized .panel-content {
        display: none;
      }

      #togglePanel {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      #togglePanel:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      #controlPanel h3 {
        margin: 0 0 15px 0;
        font-size: 16px;
        font-weight: 600;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding-bottom: 10px;
      }

      .control-group {
        margin-bottom: 15px;
      }

      .control-group:last-child {
        margin-bottom: 0;
      }

      .control-group label {
        display: block;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 6px;
        color: rgba(255, 255, 255, 0.8);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .control-group select {
        width: 100%;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: white;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .control-group select:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .control-group select:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
      }

      .control-group button {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }

      .control-group button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .control-group button:active {
        transform: translateY(0);
      }

      .control-group button.active {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      @media (max-width: 768px) {
        #controlPanel {
          top: 10px;
          left: 10px;
          right: 10px;
          min-width: auto;
          padding: 15px;
        }

        #controlPanel h3 {
          font-size: 14px;
        }

        .control-group select,
        .control-group button {
          font-size: 13px;
        }
      }
    </style>
  </head>

  <body>
    <!-- Control Panel -->
    <div id="controlPanel">
      <button id="togglePanel" title="Minimize/Expand">‚àí</button>
      <div class="panel-content">
        <h3>üéÆ VR Controls</h3>
        
        <div class="control-group">
          <label>üé¨ Video Source</label>
          <select id="videoSelector">
            <option value="video360.mp4">Video 360 v1</option>
            <option value="video360v2.mp4" selected>Video 360 v2</option>
          </select>
        </div>

        <div class="control-group">
          <label>üéôÔ∏è Commentary Voice</label>
          <select id="toneSelector">
            <option value="female">üë© Woman</option>
            <option value="male">üë® Man</option>
          </select>
        </div>

        <div class="control-group">
          <button id="commentaryToggle">‚ñ∂Ô∏è Play Commentary</button>
        </div>
      </div>
    </div>

    <!-- A-Frame VR Scene -->
    <a-scene>
      <!-- 360 video source (outside scene for better control) -->
      <a-assets>
        <video id="v360" src="video360v2.mp4" autoplay loop crossorigin="anonymous" playsinline muted></video>
        <audio id="commentaryMale" src="Man.mp3" preload="auto"></audio>
        <audio id="commentaryFemale" src="Woman.mp3" preload="auto"></audio>
      </a-assets>

      <!-- 360 video sphere -->
      <a-videosphere src="#v360"></a-videosphere>

      <!-- Camera with device orientation controls -->
      <a-entity camera look-controls="magicWindowTrackingEnabled: true; touchEnabled: true; mouseEnabled: true"></a-entity>

    </a-scene>

    <script>
      // Control panel toggle
      const controlPanel = document.getElementById('controlPanel');
      const togglePanelBtn = document.getElementById('togglePanel');
      let panelMinimized = false;

      togglePanelBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        panelMinimized = !panelMinimized;
        if (panelMinimized) {
          controlPanel.classList.add('minimized');
          togglePanelBtn.textContent = '+';
          togglePanelBtn.title = 'Expand';
        } else {
          controlPanel.classList.remove('minimized');
          togglePanelBtn.textContent = '‚àí';
          togglePanelBtn.title = 'Minimize';
        }
      });

      // Tone selector now chooses commentary track (man / woman)
      const toneSelector = document.getElementById('toneSelector');

      // Ensure video plays
      const video = document.getElementById('v360');
      // Reinforce inline playback across mobile browsers
      video.setAttribute('playsinline', 'true');
      video.setAttribute('webkit-playsinline', 'true');
      video.muted = true; // keep muted for autoplay policy
      // Force normal playback speed in case the browser throttles or speeds it up
      video.playbackRate = 1;
      video.addEventListener('ratechange', () => {
        if (video.playbackRate !== 1) {
          video.playbackRate = 1;
        }
      });
      
      // Try to play video when scene is loaded
      document.querySelector('a-scene').addEventListener('loaded', () => {
        video.play().catch(e => {
          console.log('Autoplay prevented, click to start video');
        });
      });

      // Click anywhere to start video if autoplay fails
      document.body.addEventListener('click', () => {
        if (video.paused) {
          video.play();
        }
      }, { once: true });

      // Debug: check if video is loading
      video.addEventListener('loadeddata', () => {
        console.log('Video loaded successfully');
      });
      
      video.addEventListener('error', (e) => {
        console.error('Video error:', e);
      });

      // Commentator audio (man / woman) via MP3 tracks
      const commentaryToggle = document.getElementById('commentaryToggle');
      const maleAudio = document.getElementById('commentaryMale');
      const femaleAudio = document.getElementById('commentaryFemale');
      const commentaryTracks = {
        male: maleAudio,
        female: femaleAudio,
      };

      // Debug: Check if audio files are loading
      Object.entries(commentaryTracks).forEach(([name, track]) => {
        track.addEventListener('loadeddata', () => {
          console.log(`${name} audio loaded successfully`);
        });
        track.addEventListener('error', (e) => {
          console.error(`${name} audio error:`, e, 'src:', track.src);
        });
      });

      // Video source switching
      const videoSelector = document.getElementById('videoSelector');
      const switchVideo = (src) => {
        video.pause();
        video.currentTime = 0;
        video.src = src;
        video.load();
        // Keep enforced settings
        video.playbackRate = 1;
        video.play().catch(err => console.warn('Video play blocked:', err));
      };

      videoSelector.addEventListener('change', (e) => {
        switchVideo(e.target.value);
      });

      Object.values(commentaryTracks).forEach(track => {
        track.loop = true;
        track.playbackRate = 1;
        track.volume = 1.0;
        track.muted = false;
        track.addEventListener('ratechange', () => {
          if (track.playbackRate !== 1) track.playbackRate = 1;
        });
      });

      let commentaryOn = false;

      const stopAllCommentary = () => {
        Object.values(commentaryTracks).forEach(track => {
          track.pause();
          track.currentTime = 0;
        });
      };

      const playSelectedCommentary = () => {
        stopAllCommentary();
        const selected = toneSelector.value;
        const track = commentaryTracks[selected];
        if (track) {
          track.play().catch(err => console.warn('Commentary play blocked:', err));
        }
      };

      const startCommentary = () => {
        commentaryOn = true;
        commentaryToggle.textContent = '‚è∏Ô∏è Stop Commentary';
        commentaryToggle.classList.add('active');
        playSelectedCommentary();
      };

      commentaryToggle.addEventListener('click', () => {
        commentaryOn = !commentaryOn;
        if (commentaryOn) {
          commentaryToggle.textContent = '‚è∏Ô∏è Stop Commentary';
          commentaryToggle.classList.add('active');
          playSelectedCommentary();
        } else {
          commentaryToggle.textContent = '‚ñ∂Ô∏è Play Commentary';
          commentaryToggle.classList.remove('active');
          stopAllCommentary();
        }
      });

      toneSelector.addEventListener('change', () => {
        if (commentaryOn) {
          playSelectedCommentary();
        }
      });

      // Commentary is now manual - user must click Play Commentary button to start
    </script>

  </body>
</html>
